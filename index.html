<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swiss Military Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 900px;
      margin: auto;
      background: #f7f9fc;
    }

    h2 { text-align: center; }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
    }

    button:hover { opacity: 0.9; }

    .btn-danger { background: #dc2626; }

    pre {
      background:#f5f5f5;
      padding:10px;
      white-space: pre-wrap;
      border-radius: 6px;
    }

    .hide { display:none; }

    #photoInput { display:none; }

    #preview {
      width:100%;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #ddd;
    }

    .loc-chip {
      background:#eef;
      padding:8px 10px;
      border-radius:8px;
      margin:6px 0;
      font-weight: 600;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row button { width: 50%; }

    table {
      width:100%;
      border-collapse: collapse;
      margin-top:10px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border:1px solid #eee;
      padding:8px;
      font-size:13px;
      text-align: left;
    }

    th { background:#f1f5f9; }

    #loginMsg, #msg { font-weight: 600; }
  </style>
</head>
<body>

<h2>üìçSwiss Military Attendance Portal</h2>

<div id="loginBox" class="card">
  <h3>üîê Login</h3>
  <input id="username" placeholder="Username"/>
  <input id="password" type="password" placeholder="Password"/>
  <button id="loginBtn">Login</button>
  <p id="loginMsg"></p>
</div>

<!-- USER PORTAL -->
<div id="appBox" class="hide card">
  <p>Welcome, <b id="who"></b></p>
  <pre id="coords">Fetching GPS...</pre>
  <div id="nearLoc" class="loc-chip">Detecting nearest location...</div>

  <button id="openCameraBtn">üì∏ Take Photo</button>
  <input type="file" id="photoInput" accept="image/*" capture="environment"/>
  <img id="preview" class="hide"/>

  <div class="row">
    <button id="punchBtn">‚úÖ Punch IN</button>
    <button id="punchOutBtn" class="btn-danger">‚õî Punch OUT</button>
  </div>

  <p id="msg"></p>
</div>

<!-- ADMIN PANEL -->
<div id="adminBox" class="hide card">
  <h3>üõ† Admin Dashboard ‚Äì Attendance Table</h3>

  <select id="filterType">
    <option value="today">Today</option>
    <option value="yesterday">Yesterday</option>
    <option value="custom">Custom Range</option>
  </select>

  <div id="customRange" class="hide">
    <input type="date" id="startDate"/>
    <input type="date" id="endDate"/>
  </div>

  <div class="row">
    <button onclick="loadAdminAttendance()">üîç Filter</button>
    <button onclick="exportExcel()">‚¨áÔ∏è Download Excel</button>
  </div>

  <div id="adminTable"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://qvjjinoubpqwtxbujkrd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2amppbm91YnBxd3R4YnVqa3JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MDUyNjksImV4cCI6MjA4NDQ4MTI2OX0.9rr0oUJWJBk0e9hSz-kVF9K-N6m6mwZEnSCQvxjI5XU";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// üîê Hardcoded Admin
const ADMIN_USER = "admin";
const ADMIN_PASS = "admin123";

let USER=null, GPS=null, ALL_LOCATIONS=[], NEAREST=null, ADMIN_DATA=[];

const loginBox = document.getElementById("loginBox");
const appBox = document.getElementById("appBox");
const adminBox = document.getElementById("adminBox");
const adminTable = document.getElementById("adminTable");
const loginMsg = document.getElementById("loginMsg");
const who = document.getElementById("who");
const coords = document.getElementById("coords");
const nearLoc = document.getElementById("nearLoc");
const msg = document.getElementById("msg");
const photoInput = document.getElementById("photoInput");
const preview = document.getElementById("preview");
const openCameraBtn = document.getElementById("openCameraBtn");

loginBtn.onclick = login;
punchBtn.onclick = punchIn;
punchOutBtn.onclick = punchOut;

filterType.onchange = ()=> {
  customRange.classList.toggle("hide", filterType.value !== "custom");
};

openCameraBtn.onclick = ()=> photoInput.click();
photoInput.onchange = ()=>{
  const f = photoInput.files[0];
  if(f){
    preview.src = URL.createObjectURL(f);
    preview.classList.remove("hide");
  }
};

async function login(){
  loginMsg.innerText = "Logging in...";
  const u = username.value.trim().toLowerCase();
  const p = password.value.trim();

  if (u === ADMIN_USER && p === ADMIN_PASS) {
    loginBox.classList.add("hide");
    adminBox.classList.remove("hide");
    loadAdminAttendance();
    return;
  }

  const { data, error } = await sb.from("users").select("*").ilike("username", u).single();
  if (error || !data) return loginMsg.innerText = "‚ùå User not found";
  if (data.password !== p) return loginMsg.innerText = "‚ùå Wrong password";

  USER = data;
  who.innerText = USER.username;
  loginBox.classList.add("hide");
  appBox.classList.remove("hide");

  await loadLocations();
  getLocation();
}

async function loadAdminAttendance(){
  const filter = filterType.value;
  const today = new Date().toLocaleDateString("en-CA");

  let q = sb.from("attendance").select("*").order("created_at", { ascending:false });

  if (filter === "today") q = q.eq("punch_date", today);
  if (filter === "yesterday") {
    const y = new Date(); y.setDate(y.getDate()-1);
    q = q.eq("punch_date", y.toLocaleDateString("en-CA"));
  }
  if (filter === "custom") {
    if (startDate.value && endDate.value)
      q = q.gte("punch_date", startDate.value).lte("punch_date", endDate.value);
  }

  const { data } = await q;
  ADMIN_DATA = data || [];

  let html = "<table><tr><th>User</th><th>Date</th><th>Time</th><th>Type</th><th>Location</th></tr>";
  ADMIN_DATA.forEach(r=>{
    html += `<tr><td>${r.username}</td><td>${r.punch_date||""}</td><td>${r.punch_time||""}</td><td>${r.punch_type}</td><td>${r.location_name||""}</td></tr>`;
  });
  html += "</table>";
  adminTable.innerHTML = html;
}

function exportExcel(){
  if (!ADMIN_DATA.length) return alert("No data");

  let csv = "User,Date,Time,Type,Location\n";
  ADMIN_DATA.forEach(r=>{
    csv += `${r.username},${r.punch_date},${r.punch_time},${r.punch_type},${r.location_name}\n`;
  });

  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "attendance.csv";
  a.click();
}

/* ==== TERA ORIGINAL USER LOGIC AS IT IS ==== */

async function loadLocations(){
  const { data } = await sb.from("locations_master").select("id,name,lat,lon");
  ALL_LOCATIONS = data || [];
}

function getLocation(){
  navigator.geolocation.getCurrentPosition((pos)=>{
    GPS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    coords.innerText = `Lat: ${GPS.lat}\nLon: ${GPS.lon}`;
    detectNearestLocation();
  });
}

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000;
  const dlat=(lat2-lat1)*Math.PI/180;
  const dlon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dlat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dlon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function detectNearestLocation(){
  let nearest=null, minDist=Infinity;
  ALL_LOCATIONS.forEach(loc=>{
    const d = haversine(GPS.lat, GPS.lon, loc.lat, loc.lon);
    if (d < minDist) { minDist=d; nearest=loc; }
  });
  if (nearest && minDist <= 500) {
    NEAREST = nearest;
    nearLoc.innerText = `üìå Near Location: ${nearest.name} (${Math.round(minDist)} m)`;
  } else {
    NEAREST=null;
    nearLoc.innerText = "üìå Near Location: None";
  }
}

async function punchIn(){
  if (!GPS || !NEAREST) return msg.innerText="‚ùå Location not valid";
  const file = photoInput.files[0];
  if (!file) return alert("Photo required");

  const today = new Date().toLocaleDateString("en-CA");

  const { data: alreadyIn } = await sb
    .from("attendance")
    .select("id")
    .eq("user_id", USER.id)
    .eq("punch_type", "IN")
    .eq("location_id", NEAREST.id)
    .eq("punch_date", today);

  if (alreadyIn && alreadyIn.length > 0) {
    msg.innerText = "‚ùå Aap aaj is location par Punch IN already kar chuke ho";
    return;
  }

  const path = `${USER.id}/${Date.now()}_${file.name}`;
  await sb.storage.from("attendance-photos").upload(path, file);

  const now = new Date();
  const date = now.toLocaleDateString("en-CA");
  const time = now.toLocaleTimeString("en-GB",{hour12:false});

  await sb.from("attendance").insert({
    user_id: USER.id,
    username: USER.username,
    punch_type: "IN",
    location_id: NEAREST.id,
    location_name: NEAREST.name,
    lat: GPS.lat,
    lon: GPS.lon,
    photo_url: path,
    punch_date: date,
    punch_time: time
  });

  msg.innerText="‚úÖ Punch IN success";
}

async function punchOut(){
  if (!GPS || !NEAREST) return msg.innerText="‚ùå Location not valid";
  const file = photoInput.files[0];
  if (!file) return alert("Photo required");

  const path = `${USER.id}/${Date.now()}_${file.name}`;
  await sb.storage.from("attendance-photos").upload(path, file);

  const now = new Date();
  const date = now.toLocaleDateString("en-CA");
  const time = now.toLocaleTimeString("en-GB",{hour12:false});

  await sb.from("attendance").insert({
    user_id: USER.id,
    username: USER.username,
    punch_type: "OUT",
    location_id: NEAREST.id,
    location_name: NEAREST.name,
    lat: GPS.lat,
    lon: GPS.lon,
    photo_url: path,
    punch_date: date,
    punch_time: time
  });

  msg.innerText="‚úÖ Punch OUT success";
}
</script>
</body>
</html>

