<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swiss Military Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 520px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 6px 0; }
    pre { background:#f5f5f5; padding:10px; white-space: pre-wrap; }
    .hide { display:none; }
    #photoInput { display:none; }
    #preview { width:100%; margin-top:8px; border-radius:8px; border:1px solid #ddd; }
    .loc-chip { background:#eef; padding:8px 10px; border-radius:8px; margin:6px 0; }
  </style>
</head>
<body>

<h2>üìçSwiss Military Attendance Portal</h2>

<div id="loginBox">
  <input id="username" placeholder="Username"/>
  <input id="password" type="password" placeholder="Password"/>
  <button id="loginBtn">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="appBox" class="hide">
  <p>Welcome, <b id="who"></b></p>
  <pre id="coords">Fetching GPS...</pre>
  <div id="nearLoc" class="loc-chip">Detecting nearest location...</div>

  <!-- üì∏ Camera UI -->
  <button id="openCameraBtn">üì∏ Take Photo</button>
  <input type="file" id="photoInput" accept="image/*" capture="environment"/>
  <img id="preview" class="hide"/>

  <button id="punchBtn">‚úÖ Punch IN</button>
  <button id="punchOutBtn">‚õî Punch OUT</button>
  <p id="msg"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://qvjjinoubpqwtxbujkrd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2amppbm91YnBxd3R4YnVqa3JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MDUyNjksImV4cCI6MjA4NDQ4MTI2OX0.9rr0oUJWJBk0e9hSz-kVF9K-N6m6mwZEnSCQvxjI5XU";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let USER=null, GPS=null, ALL_LOCATIONS=[], NEAREST=null;

const loginBox = document.getElementById("loginBox");
const appBox = document.getElementById("appBox");
const loginMsg = document.getElementById("loginMsg");
const who = document.getElementById("who");
const coords = document.getElementById("coords");
const nearLoc = document.getElementById("nearLoc");
const msg = document.getElementById("msg");
const photoInput = document.getElementById("photoInput");
const preview = document.getElementById("preview");
const openCameraBtn = document.getElementById("openCameraBtn");

loginBtn.onclick = login;
punchBtn.onclick = punchIn;
punchOutBtn.onclick = punchOut;

openCameraBtn.onclick = ()=> photoInput.click();
photoInput.onchange = ()=>{
  const f = photoInput.files[0];
  if(f){
    preview.src = URL.createObjectURL(f);
    preview.classList.remove("hide");
  }
};

async function login(){
  loginMsg.innerText = "Logging in...";
  const u = username.value.trim().toLowerCase();
  const p = password.value.trim();

  const { data, error } = await sb.from("users").select("*").ilike("username", u).single();
  if (error || !data) return loginMsg.innerText = "‚ùå User not found";
  if (data.password !== p) return loginMsg.innerText = "‚ùå Wrong password";

  USER = data;
  who.innerText = USER.username;
  loginBox.classList.add("hide");
  appBox.classList.remove("hide");

  await loadLocations();
  getLocation();
}

async function loadLocations(){
  const { data, error } = await sb.from("locations_master").select("id,name,lat,lon");
  if (error) return msg.innerText = "‚ùå Locations load failed";
  ALL_LOCATIONS = data || [];
}

function getLocation(){
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      GPS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      coords.innerText = `Lat: ${GPS.lat}\nLon: ${GPS.lon}`;
      detectNearestLocation();
    },
    ()=>coords.innerText = "‚ùå Location permission denied",
    { enableHighAccuracy:true }
  );
}

function haversine(lat1, lon1, lat2, lon2){
  const R=6371000;
  const dlat=(lat2-lat1)*Math.PI/180;
  const dlon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dlat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dlon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function detectNearestLocation(){
  if (!GPS || ALL_LOCATIONS.length === 0) return;

  let nearest = null;
  let minDist = Infinity;

  ALL_LOCATIONS.forEach(loc=>{
    const d = haversine(GPS.lat, GPS.lon, loc.lat, loc.lon);
    if (d < minDist) {
      minDist = d;
      nearest = loc;
    }
  });

  if (nearest && minDist <= 500) {
    NEAREST = nearest;
    nearLoc.innerText = `üìå Near Location: ${nearest.name} (${Math.round(minDist)} m)`;
  } else {
    NEAREST = null;
    nearLoc.innerText = `üìå Near Location: None (Not within 500m of any DB location)`;
  }
}

async function punchIn(){
  if (!GPS) return alert("GPS not ready");
  if (!NEAREST) return msg.innerText = "‚ùå Aap kisi DB location ke paas nahi ho";

  const today = new Date().toISOString().slice(0,10);

  const { data: already } = await sb
    .from("attendance")
    .select("id")
    .eq("user_id", USER.id)
    .eq("punch_type", "IN")
    .eq("location_id", NEAREST.id)
    .gte("created_at", today + "T00:00:00")
    .lte("created_at", today + "T23:59:59");

  if (already && already.length > 0) {
    msg.innerText = "‚ùå Aap is location par aaj Punch IN kar chuke ho";
    return;
  }

  const file = photoInput.files[0];
  if (!file) return alert("Photo required");

  const path = `${USER.id}/${Date.now()}_${file.name}`;
  await sb.storage.from("attendance-photos").upload(path, file);

  await sb.from("attendance").insert({
    user_id: USER.id,
    username: USER.username,
    location_id: NEAREST.id,
    lat: GPS.lat,
    lon: GPS.lon,
    distance_meters: haversine(GPS.lat, GPS.lon, NEAREST.lat, NEAREST.lon),
    photo_url: path,
    punch_type: "IN"
  });

  msg.innerText = "‚úÖ Punch IN success";
}

async function punchOut(){
  if (!GPS) return alert("GPS not ready");
  if (!NEAREST) return msg.innerText = "‚ùå Aap kisi DB location ke paas nahi ho";

  const file = photoInput.files[0];
  if (!file) return alert("Photo required");

  const path = `${USER.id}/${Date.now()}_${file.name}`;
  await sb.storage.from("attendance-photos").upload(path, file);

  await sb.from("attendance").insert({
    user_id: USER.id,
    username: USER.username,
    location_id: NEAREST.id,
    lat: GPS.lat,
    lon: GPS.lon,
    distance_meters: haversine(GPS.lat, GPS.lon, NEAREST.lat, NEAREST.lon),
    photo_url: path,
    punch_type: "OUT"
  });

  msg.innerText = "‚úÖ Punch OUT success";
}
</script>
</body>
</html>
