<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swiss Military Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 900px; margin: auto; }
    input, button, select { width: 100%; padding: 10px; margin: 6px 0; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:6px; font-size:13px; }
    th { background:#f5f5f5; }
    .hide { display:none; }
    .tabs button { width:auto; margin-right:6px; }
    img { border-radius:6px; margin:6px; }
  </style>
</head>
<body>

<h2>üìçSwiss Military Attendance Portal</h2>

<div id="loginBox">
  <input id="username" placeholder="Username"/>
  <input id="password" type="password" placeholder="Password"/>
  <button id="loginBtn">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="userBox" class="hide">
  <!-- üîí USER PORTAL (unchanged logic) -->
  <p>Welcome, <b id="who"></b></p>
  <pre id="coords">Fetching GPS...</pre>
  <div id="nearLoc"></div>

  <input type="file" id="photoInput" accept="image/*" capture="environment"/>
  <button id="punchBtn">Punch IN</button>
  <button id="punchOutBtn">Punch OUT</button>
  <p id="msg"></p>
</div>

<div id="adminBox" class="hide">
  <h3>üõ† Admin Dashboard</h3>

  <select id="dateFilter">
    <option value="today">Today</option>
    <option value="yesterday">Yesterday</option>
    <option value="7days">Last 7 Days</option>
    <option value="custom">Custom Range</option>
  </select>

  <div id="customDates" class="hide">
    <input type="date" id="startDate"/>
    <input type="date" id="endDate"/>
    <button onclick="loadAdminData()">Apply</button>
  </div>

  <div class="tabs">
    <button onclick="showTab('table')">üìä Attendance Table</button>
    <button onclick="showTab('photos')">üì∏ Attendance Photos</button>
    <button onclick="showTab('remarks')">üìù Movement / Expense Remarks</button>
  </div>

  <div id="tabTable"></div>
  <div id="tabPhotos" class="hide"></div>
  <div id="tabRemarks" class="hide"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://qvjjinoubpqwtxbujkrd.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let USER=null;

loginBtn.onclick = async ()=>{
  const u = username.value.trim().toLowerCase();
  const p = password.value.trim();

  const { data } = await sb.from("users").select("*").ilike("username", u).single();
  if (!data || data.password !== p) return loginMsg.innerText="‚ùå Wrong login";

  USER=data;
  loginBox.classList.add("hide");

  if (u === "admin") {
    adminBox.classList.remove("hide");
    loadAdminData();
  } else {
    userBox.classList.remove("hide");
    who.innerText = USER.username;
  }
};

function showTab(tab){
  tabTable.classList.add("hide");
  tabPhotos.classList.add("hide");
  tabRemarks.classList.add("hide");
  document.getElementById("tab"+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove("hide");
}

async function loadAdminData(){
  let q = sb.from("attendance").select("*").order("created_at", { ascending:false });

  const { data } = await q;

  // TABLE
  let html = "<table><tr><th>User</th><th>Date</th><th>Time</th><th>Type</th><th>Location</th></tr>";
  (data||[]).forEach(r=>{
    html += `<tr><td>${r.username}</td><td>${r.punch_date}</td><td>${r.punch_time}</td><td>${r.punch_type}</td><td>${r.location_name||""}</td></tr>`;
  });
  html += "</table>";
  tabTable.innerHTML = html;

  // PHOTOS
  let phtml = "";
  (data||[]).forEach(r=>{
    if(r.photo_url){
      const { data:urlData } = sb.storage.from("attendance-photos").getPublicUrl(r.photo_url);
      phtml += `<img src="${urlData.publicUrl}" width="140"/><div>${r.username} - ${r.punch_type}</div>`;
    }
  });
  tabPhotos.innerHTML = phtml;

  // REMARKS
  const { data:remarks } = await sb.from("attendance_remarks").select("*").order("created_at", { ascending:false });
  let rhtml = "<table><tr><th>User</th><th>Date</th><th>Time</th><th>Remark</th></tr>";
  (remarks||[]).forEach(r=>{
    rhtml += `<tr><td>${r.user_name}</td><td>${r.date}</td><td>${r.time}</td><td>${r.remark}</td></tr>`;
  });
  rhtml += "</table>";
  tabRemarks.innerHTML = rhtml;
}
</script>
</body>
</html>
