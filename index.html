<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GPS Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial; padding: 16px; }
    input, select, button { padding: 10px; margin: 6px 0; width: 100%; }
    pre { background:#f5f5f5; padding:10px; }
    .ok { color: green; }
    .err { color: red; }
  </style>
</head>
<body>

<h2>üìç GPS Attendance System</h2>

<!-- LOGIN -->
<div id="login">
  <input id="username" placeholder="Username"/>
  <input id="password" type="password" placeholder="Password"/>
  <button onclick="login()">Login</button>
  <p id="loginMsg"></p>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <p>Welcome <b id="who"></b></p>

  <button onclick="getLocation()">üìç Get My Location</button>
  <pre id="coords">No GPS yet</pre>

  <select id="mode" onchange="onModeChange()">
    <option value="">Select Option</option>
    <option value="existing">Existing Location</option>
    <option value="new">New Location</option>
  </select>

  <div id="existingBox" style="display:none;">
    <select id="locations"></select>
  </div>

  <div id="newBox" style="display:none;">
    <input id="locName" placeholder="Enter new location name"/>
  </div>

  <input type="file" id="photo" accept="image/*" capture="environment"/>

  <button onclick="punchIn()">‚úÖ Punch IN</button>
  <p id="msg"></p>
</div>

<script>
const API = "https://YOUR_BACKEND_URL";   // FastAPI URL
let TOKEN = null;
let GPS = null;
let USER_ID = null;

async function login(){
  const r = await fetch(API+"/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username: username.value, password: password.value })
  });
  const d = await r.json();
  if (d.user_id){
    USER_ID = d.user_id;
    TOKEN = d.token;
    who.innerText = username.value;
    login.style.display="none";
    app.style.display="block";
    loadLocations();
  } else {
    loginMsg.innerText = "‚ùå Invalid login";
  }
}

function getLocation(){
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      GPS = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      coords.innerText = `Lat: ${GPS.lat}\nLon: ${GPS.lon}`;
    },
    ()=>alert("Allow location"),
    { enableHighAccuracy:true }
  );
}

function onModeChange(){
  existingBox.style.display = mode.value==="existing" ? "block" : "none";
  newBox.style.display = mode.value==="new" ? "block" : "none";
}

async function loadLocations(){
  const r = await fetch(API+`/locations?user_id=${USER_ID}`);
  const list = await r.json();
  locations.innerHTML = list.map(l=>`<option value="${l.id}">${l.name}</option>`).join("");
}

async function punchIn(){
  if (!GPS) return alert("Get GPS first");
  const photoFile = photo.files[0];
  const form = new FormData();
  form.append("user_id", USER_ID);
  form.append("lat", GPS.lat);
  form.append("lon", GPS.lon);
  form.append("mode", mode.value);
  form.append("location_id", locations.value || "");
  form.append("location_name", locName.value || "");
  form.append("photo", photoFile);

  const r = await fetch(API+"/punch-in", { method:"POST", body: form });
  const d = await r.json();
  msg.innerText = d.ok ? "‚úÖ Punch IN Success" : "‚ùå " + d.error;
}
</script>

</body>
</html>
